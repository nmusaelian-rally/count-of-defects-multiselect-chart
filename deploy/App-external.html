<!DOCTYPE html>
<html>
<head>
    <title>Count of Defects, TTR</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",stateful:!0,weeks:[],numberOfWeeks:16,textShowingCurrentSelection:"Current Selection:<p />",arrOfCreationDateFilters:[],arrOfFixedAndLimitedByCreationDateFilters:[],created:[],fixedWithinTTR:[],ttr1:28,ttr2:84,allData:[],categories:[],getState:function(){return{tags:this.getTagRefsFromTagObjects(),numberOfWeeks:this.down("#numberOfWeeks").getValue()}},launch:function(){this.getDates(),this.makePage()},makePage:function(){console.log("make page");var widgetPanel=Ext.create("Ext.Panel",{itemId:"widget",layout:{type:"hbox",align:"middle"},items:[{xtype:"rallytagpicker",itemId:"tagPicker",stateful:!0,stateId:this.getContext().getScopedStateId("n-tags"),value:this.tags,fieldLabel:"Tags:",listeners:{select:this.onTagsSelected,deselect:this.onTagsSelected,scope:this},margin:20},{xtype:"rallyfieldvaluecombobox",itemId:"priorityCombobox",model:"Defect",multiSelect:!0,defaultSelectionPosition:null,field:"Priority",fieldLabel:"Priority:",stateful:!0,stateId:this.getContext().getScopedStateId("n-priority"),listeners:{select:this.getFilter,ready:this.getFilter,scope:this},margin:20},{xtype:"numberfield",itemId:"numberOfWeeks",fieldLabel:"Number of Weeks",value:this.numberOfWeeks,maxValue:56,minValue:0,hideTrigger:!0,listeners:{change:this.getNumberOfWeeks,scope:this},margin:20}]}),selectionSummaryPanel=Ext.create("Ext.Panel",{itemId:"selectionSummaryPanel",layout:{type:"hbox",align:"stretch"},items:[{xtype:"container",itemId:"mySelections",html:this.textShowingCurrentSelection,flex:2},{xtype:"rallybutton",itemId:"applyButton",text:"Apply Filters",maxHeight:20,cls:"",listeners:{click:this.createFilters,scope:this},margin:20}]}),gridPanel=Ext.create("Ext.Panel",{itemId:"gridPanel",layout:{type:"hbox",align:"stretch"},items:[{xtype:"panel",title:"Grid Panel 1",itemId:"gridPanel1",flex:1},{xtype:"panel",title:"Grid Panel 2",itemId:"gridPanel2",flex:1}]}),chartPanel=Ext.create("Ext.Panel",{title:"Chart Panel",itemId:"chartPanel"});this.add(widgetPanel),this.add(selectionSummaryPanel),this.add(gridPanel),this.add(chartPanel),this.tags.length>0&&(this.down("#driChart")&&Ext.ComponentQuery.query("#chartPanel")[0].remove(Ext.ComponentQuery.query("#driChart")[0],!0),this.down("#detailsGrid")&&Ext.ComponentQuery.query("#gridPanel1")[0].remove(Ext.ComponentQuery.query("#defectGrid")[0],!0),this.down("#detailsGrid")&&Ext.ComponentQuery.query("#gridPanel2")[0].remove(Ext.ComponentQuery.query("#detailsGrid")[0],!0),this.createFilters())},getFilter:function(){console.log("getFilter");var priorityBox=Ext.ComponentQuery.query("rallyfieldvaluecombobox[itemId=priorityCombobox]")[0];console.log("selected priorities:",priorityBox.getValue())},onTagsSelected:function(){console.log("onTagsSelected"),this.tags=this.getTagRefsFromTagObjects(),this.saveState()},getTagRefsFromTagObjects:function(){console.log("getTagRefsFromTagObjects");var tagsRefs=[],tags=Ext.ComponentQuery.query("rallytagpicker[itemId=tagPicker]")[0]._getRecordValue();return console.log("_getRecordValue()...",tags),_.each(tags,function(tag){console.log(tag.data._ref),tagsRefs.push(tag.data._ref)}),console.log(tagsRefs),tagsRefs},getNumberOfWeeks:function(){console.log("ggetNumberOfWeeks"),console.log(this.down("#numberOfWeeks").getValue()),this.numberOfWeeks=this.down("#numberOfWeeks").getValue(),this.saveState()},getDates:function(){console.log("getDates");var now=new Date,today=now.getDay(),saturday=6,padding=1,howFarBack=this.numberOfWeeks+padding,saturdayDates=[],closestSaturday=null,prevSaturday=null,weeks=[],daysFromLastSaturday=today-saturday;closestPastSaturday=new Date(now-864e5*daysFromLastSaturday-6048e5),saturdayDates.push(Rally.util.DateTime.format(closestPastSaturday,"Y-m-d")),console.log("today:",today,"daysFromLastSaturday:",daysFromLastSaturday,"closestPastSaturday:",closestPastSaturday);for(var i=1;howFarBack>i;i++)prevSaturday=new Date(closestPastSaturday-6048e5),saturdayDates.push(Rally.util.DateTime.format(prevSaturday,"Y-m-d")),closestPastSaturday=prevSaturday;console.log("saturdayDates:",saturdayDates);for(var j=0;saturdayDates.length-1>j;j++){var week={};week.end=saturdayDates[j],week.start=saturdayDates[j+1],this.weeks.push(week)}this.defectDetails=Array(this.numberOfWeeks);for(var i=0;this.numberOfWeeks>i;i++)this.defectDetails[i]=[]},createFilters:function(){console.log("createFilter"),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait.This may take long..."}),this._myMask.show();var tagFilter,arrOfTagFilterObjects=[],codeResolitionFilter,closedFilter,fixedFilter,closedDateFilters=[],creationDateFilters=[],container=Ext.ComponentQuery.query("container[itemId=mySelections]")[0];this.tags.length>0,_.each(this.tags,function(tag){arrOfTagFilterObjects.push({property:"Tags",operator:"contains",value:tag})},this),tagFilter=Rally.data.wsapi.Filter.or(arrOfTagFilterObjects),this.textShowingCurrentSelection+=""+tagFilter,container.update(this.textShowingCurrentSelection),closedFilter=tagFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"State",value:"Closed"})),codeResolitionFilter=Rally.data.wsapi.Filter.or([{property:"Resolution",value:"Code Change"},{property:"Resolution",value:"Database/Metadata Change"},{property:"Resolution",value:"Configuration Change"}]),fixedFilter=closedFilter.and(codeResolitionFilter),_.each(this.weeks,function(week){var creationDateFilter=Rally.data.wsapi.Filter.and([{property:"CreationDate",operator:">=",value:week.start},{property:"CreationDate",operator:"<",value:week.end}]);this.arrOfCreationDateFilters.push(tagFilter.and(creationDateFilter)),this.arrOfFixedAndLimitedByCreationDateFilters.push(fixedFilter.and(creationDateFilter))},this),console.log(this.arrOfCreationDateFilters.length," Creation Date Filters--------"),_.each(this.arrOfCreationDateFilters,function(filter){console.log(""+filter)},this),console.log(this.arrOfFixedAndLimitedByCreationDateFilters.length," Fixed Filters limited by Creation Dates-----------"),_.each(this.arrOfFixedAndLimitedByCreationDateFilters,function(filter){console.log(""+filter)},this),this.makeStore()},makeStore:function(){console.log("makeStore"),this.concatArraysOfFilters=this.arrOfCreationDateFilters.concat(this.arrOfFixedAndLimitedByCreationDateFilters),this.defectStore=Ext.create("Rally.data.wsapi.Store",{model:"Defect",fetch:["Name","State","Resolution","FormattedID","CreationDate","ClosedDate","Owner","Project","Priority"],limit:1/0}),this.applyFiltersToStore(0)},applyFiltersToStore:function(i){console.log("applyFilterToStore"),this.defectStore.addFilter(this.concatArraysOfFilters[i]),this.defectStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(this.numberOfWeeks>i?(this.created.push(records.length),_.each(records,function(record){var owner=record.get("Owner");this.defectDetails[i].push({_ref:record.get("_ref"),FormattedID:record.get("FormattedID"),Name:record.get("Name"),State:record.get("State"),Resolution:record.get("Resolution"),Priority:record.get("Priority"),Owner:owner&&owner._refObjectName||"None",Project:record.get("Project")._refObjectName,CreationDate:Rally.util.DateTime.format(record.get("CreationDate"),"Y-m-d"),ClosedDate:Rally.util.DateTime.format(record.get("ClosedDate"),"Y-m-d")})},this)):this.fixedWithinTTR.push(this.getFixedDefectsWithinTTR(records)),this.defectStore.clearFilter(records.length),this.concatArraysOfFilters.length-1>i?this.applyFiltersToStore(i+1):this.makeCustomStore())}})},getFixedDefectsWithinTTR:function(records){console.log("getFixedDefectsWithinTTR");var closedDefectsWithinTTR1=[],closedDefectsWithinTTR2=[],closedDefectsWithinAllTTRs=[],arrayOfDataObjects=[];return _.each(records,function(record){var created=new Date(record.get("CreationDate")),closed=new Date(record.get("ClosedDate")),diff=Math.floor((closed-created)/864e5);this.ttr2>=diff&&closedDefectsWithinTTR2.push(record),this.ttr1>=diff&&closedDefectsWithinTTR1.push(record)},this),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR1.length),closedDefectsWithinAllTTRs.push(closedDefectsWithinTTR2.length),closedDefectsWithinAllTTRs},makeCustomStore:function(){console.log("makeCustomStore"),this.fixedWithinTTR=_.flatten(this.fixedWithinTTR);for(var fixedWithinTTR1=[],fixedWithinTTR2=[],index=0;this.fixedWithinTTR.length>index;index++)0==index%2?fixedWithinTTR1.push(this.fixedWithinTTR[index]):fixedWithinTTR2.push(this.fixedWithinTTR[index]);for(var startDates=[],endDates=[],dri1=[],dri2=[],arrOfArraysOfColumnValues=[],f=0,c=0;fixedWithinTTR1.length>f;f++,c++)dri1.push((100*(fixedWithinTTR1[f]/this.created[c])).toFixed(2));for(var f=0,c=0;fixedWithinTTR2.length>f;f++,c++)dri2.push((100*(fixedWithinTTR2[f]/this.created[c])).toFixed(2));arrOfArraysOfColumnValues.push(this.created),arrOfArraysOfColumnValues.push(fixedWithinTTR1),arrOfArraysOfColumnValues.push(fixedWithinTTR2),arrOfArraysOfColumnValues.push(dri1),arrOfArraysOfColumnValues.push(dri2),arrOfArraysOfColumnValues.push(startDates),arrOfArraysOfColumnValues.push(endDates),_.each(this.weeks,function(week){startDates.push(week.start),endDates.push(week.end)});for(var arrOfArraysOfRowValues=_.zip(arrOfArraysOfColumnValues),arrOfObjectsOfRowValues=[],i=0;arrOfArraysOfRowValues.length>i;i++){for(var o={},j=0;arrOfArraysOfRowValues[i].length>j;j++)o[j]=arrOfArraysOfRowValues[i][j];arrOfObjectsOfRowValues.push(o)}for(var i=arrOfObjectsOfRowValues.length-1;i>=0;i--)this.allData.push(arrOfObjectsOfRowValues[i]);this.makeGrid(arrOfObjectsOfRowValues)},makeGrid:function(data){var that=this;this._myMask.hide(),this.down("#gridPanel1").add({xtype:"rallygrid",itemId:"defectGrid",store:Ext.create("Rally.data.custom.Store",{data:data}),listeners:{select:this.getDetails,load:function(selModel,record,index,options){this.getDetails(selModel,record,0,options)},scope:this},columnCfgs:[{text:"Start Week",dataIndex:"5"},{text:"End Week",dataIndex:"6"},{text:"Created Defects",dataIndex:"0"},{text:"Fixed Defects (TTR <= 4 weeks)",dataIndex:"1"},{text:"Fixed Defects (TTR <= 12 weeks)",dataIndex:"2"},{text:"4 Week DRI %",dataIndex:"3"},{text:"12 Week DRI %",dataIndex:"4"}],showPagingToolbar:!1}),this.prepareChart()},getDetails:function(selModel,record,rowIndex,options){var detailsGrid=this.down("#detailsGrid");detailsGrid&&Ext.ComponentQuery.query("#gridPanel2")[0].remove(Ext.ComponentQuery.query("#detailsGrid")[0],!0),this.down("#gridPanel2").add({xtype:"rallygrid",itemId:"detailsGrid",store:Ext.create("Rally.data.custom.Store",{data:this.defectDetails[rowIndex]}),columnCfgs:[{text:"FormattedID",dataIndex:"FormattedID",xtype:"templatecolumn",tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate")},{text:"Name",dataIndex:"Name",flex:1},{text:"State",dataIndex:"State"},{text:"Project",dataIndex:"Project"},{text:"CreationDate",dataIndex:"CreationDate"},{text:"ClosedDate",dataIndex:"ClosedDate"},{text:"Resolution",dataIndex:"Resolution"},{text:"Priority",dataIndex:"Priority"}],showPagingToolbar:!0,cls:""})},prepareChart:function(){this.series=[],this.data=[[],[],[],[]];var chartData=[],numOfWeeksRunningDri1=this.ttr1/7,numOfWeeksRunningDri2=this.ttr2/7;_.each(this.allData,function(o){chartData.push({dri1:o[3],dri2:o[4],endWeek:o[6]})}),console.log("chartData..."),_.each(chartData,function(o){this.categories.push(o.endWeek),this.data[0].push(parseFloat(o.dri1)),this.data[1].push(parseFloat(o.dri2))},this),console.log(" this.data[0] before splice....",this.data[0]),this.data[2]=this.data[0].splice(0,this.data[0].length-numOfWeeksRunningDri1),this.data[3]=this.data[1].splice(0,this.data[1].length-numOfWeeksRunningDri2);for(var a=0;this.numberOfWeeks-numOfWeeksRunningDri1>a;a++)this.data[0].unshift(null);for(var b=0;this.numberOfWeeks-numOfWeeksRunningDri2>b;b++)this.data[1].unshift(null);console.log("this.data..."),_.each(this.data,function(subArray){console.log(subArray)}),this.series.push({name:"4 week running DRI",data:this.data[0],color:["#87CEEB"],dashStyle:"Dot"}),this.series.push({name:"4 week DRI",color:["#008080"],data:this.data[2]}),this.series.push({name:"12 week running DRI",data:this.data[1],color:["#8FBC8F"],dashStyle:"Dot"}),this.series.push({name:"12 week DRI",color:["#008080"],data:this.data[3]}),this.makeChart()},makeChart:function(){this._myMask.hide();var that=this;this.down("#chartPanel").add({xtype:"rallychart",itemId:"driChart",chartConfig:{chart:{type:"line",zoomType:"xy"},title:{text:"4 week and 12 week DRI"},colors:["#87CEEB","#8FBC8F","#008080","#008080"],xAxis:{title:{enabled:!0},tickInterval:1,startOnTick:!0,endOnTick:!0,showLastLabel:!0,allowDecimals:!1},yAxis:{title:{text:"Defect Resolution Index"},allowDecimals:!1,min:0},plotOptions:{line:{connectNulls:!1}}},chartData:{series:that.series,categories:that.categories}})}});

            Rally.launchApp('CustomApp', {
                name:"Count of Defects, TTR",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
